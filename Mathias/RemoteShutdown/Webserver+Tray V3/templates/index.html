<!DOCTYPE html>
<html>
<head>
    <title>Server Control</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='img/png/RemoteShutdown.png') }}">
    <style>
        /* ========================================= /*
        /* ================  C S S ================= /*
        /* ========================================= /*

        /* ===== Body & Heading ===== */
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: #f4f4f4;
            margin: 0;
            padding: 0.1rem;
        }
        h1 {
            margin: 0.5rem 0;
            font-size: 2rem;
        }

        /* ===== Toggle Switch ===== */
        .switch-container {
            display: inline-flex;
            align-items: center;
            justify-content: center; 
            background: #e0e0e0;
            border-radius: 20px;
            padding: 7px;
            cursor: pointer;
            user-select: none;
            width: 100px;
            position: relative;
            margin-bottom: 1rem;
            gap: 10px;
        }
        .switch-option {
            flex: 1;
            text-align: center;
            font-size: 0.9rem;
            color: #555;
            z-index: 1;
            transition: color 0.3s;
        }
        .switch-option img {
            height: 1.05rem;
            width: auto;
            display: block;
            margin: auto;
        }
        .switch-handle {
            position: absolute;
            top: 2px;
            left: 200px;
            width: 48px;
            height: 26px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: left 0.2s ease-in-out, width 0.2s ease-in-out, background 0.2s ease-in-out;
        }
        
        
        /* ===== Noob / Pro Toggle ===== */
        .toggle-noobpro:not(.on) .switch-handle { 
            left: 3px; 
            width: 55px; /* Noob */
            background: #8dd9a8;
        }
        .toggle-noobpro.on .switch-handle { 
            left: 63px; 
            width: 49px; /* Pro */
            background: #66bfff; 
        }

        /* ===== Language Toggle ===== */
        .toggle-lang:not(.on) .switch-handle { 
            left: 3px; 
            width: 55px; /* German flag */
            background: #8dd9a8;
        }
        .toggle-lang.on .switch-handle { 
            left: 57px; 
            width: 55px; /* English flag */
            background: #66bfff; 
        }

        /* ===== Admin Toggle ===== */
        .toggle-admin:not(.on) .switch-handle { 
            left: 3px; 
            width: 55px; /* User */
            background: #8dd9a8;
        }
        .toggle-admin.on .switch-handle { 
            left: 57px; 
            width: 55px; /* Admin */
            background: #66bfff; 
        }


        /* ===== Toggle Row Container ===== */
        .toggle-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            margin-bottom: 0rem;
        }

        /* ===== Grid Container (Tiles) ===== */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 0.8rem 1.3rem;
            justify-content: center;
            padding: 1rem;
            max-width: 1000px;
            margin: 0 auto;
        }

        /* ===== Tile Buttons ===== */
        .tile {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 90%;
            max-width: 300px;
            padding: 1rem;
            border-radius: 15px;
            color: white;
            font-weight: bold;
            font-size: 1.7rem;
            cursor: pointer;
            transition: transform 0.2s, background-color 0.3s;
            text-decoration: none;
            position: relative;
        }
        .tile img {
            width: 60px;
            height: 60px;
            margin-bottom: 0.5rem;
        }
        .tile:hover {
            transform: scale(1.05);
        }

        /* ===== Tile Texts ===== */
        .tile-name { margin-bottom: 0.5rem; }
        .tile-desc {
            font-weight: normal;
            font-size: 1.2rem;
            color: rgba(255,255,255,0.85);
            visibility: hidden;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.1s ease, opacity 0.3s ease;
        }
        .tile-desc.visible {
            max-height: 30px;
            opacity: 1;
            visibility: visible;
        }
        .pro .tile-desc { visibility: visible; }

        /* ===== Control Buttons Inside Tiles ===== */
        .control-btn {
            position: absolute;
            top: 8px;     
            right: 8px;    
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            border: none;
            border-radius: 8px;
            background-color: transparent;
            cursor: pointer;
            font-size: 0;
        }
        
        .control-btn img {
            width: 35px;
            height: 35px;
            display: block;
        }
        

        .control-btn:hover {
            transform: scale(1.15);
        }

        .control-btn:active {
            transform: scale(0.98);
        }



        /* ===== Responsive POCO X6 Pro ===== */
        @media (max-width: 600px) {
            .grid {
                grid-template-columns: repeat(3, calc((90% - 20px) / 3));
                margin-left: -15px;
                gap: 10px 25px;
            }
            .tile {             
                font-size: 1.2rem; 
                padding: 0.8rem;     
            }
            .tile img {         
                width: 45px; 
                height: 45px; 
                     
            }
            h1 {                
                margin: 0.3rem; 
                font-size: 2rem;    
            }
            .switch-container { 
                margin-bottom: 0.3rem;  
            }
            .tile-desc {        
                font-size: 1rem;    
            }
            .control-btn img {
                width: 1.7rem;
                height: 1.7rem;
            }
        }
    </style>
</head>

<body>
    <!-- ========================================= -->
    <!-- ================  H T M L =============== -->
    <!-- ========================================= -->
    
    <!-- ===== Page Heading ===== -->
    <h1>Mathias' Mediaserver</h1>

    <!-- ===== Toggle Switches ===== -->
    <div class="toggle-row">
        <!-- Noob / Pro Toggle -->
        <div id="toggleSwitch" class="switch-container toggle-noobpro on">
            <div class="switch-option left">Noob</div>
            <div class="switch-option right">&nbsp;&nbsp;Pro</div>
            <div class="switch-handle"></div>
        </div>

        <!-- Language Toggle -->
        <div id="langToggle" class="switch-container toggle-lang">
            <div class="switch-option left"><img src="/img/german.webp" width="25px"></div>
            <div class="switch-option right"><img src="/img/english.webp" width="25px"></div>
            <div class="switch-handle"></div>
        </div>

        <!-- Admin Toggle -->
        <div id="adminToggle" class="switch-container toggle-admin">
            <div class="switch-option left">User</div>
            <div class="switch-option right">Admin</div>
            <div class="switch-handle"></div>
        </div>
    </div>


    <!-- ===== Status / Action Text ===== -->
    <div id="action-status"></div>

    <!-- ===== Grid Layout (Service Tiles) ===== -->
    <div class="grid">
        <!-- ===== Standard Service Tiles ===== -->
        <a class="tile" id="tile-sonarr" href="/sonarr">
            <button class="control-btn" onclick="toggleService(event, 'sonarr')">
                <img src="/img/play.webp" alt="Start Sonarr">
            </button>
            <img src="/img/sonarr.webp" alt="Sonarr">
            <div class="tile-name">Sonarr</div>
            <div class="tile-desc" data-desc-de="Serien" data-desc-en="Series"></div>
        </a>

        <a class="tile" id="tile-radarr" href="/radarr">
            <button class="control-btn" onclick="toggleService(event, 'radarr')">
                <img src="/img/play.webp" alt="Start Radarr">
            </button>
            <img src="/img/radarr.webp" alt="Radarr">
            <div class="tile-name">Radarr</div>
            <div class="tile-desc" data-desc-de="Filme" data-desc-en="Movies"></div>
        </a>

        <a class="tile" id="tile-bazarr" href="/bazarr">
            <button class="control-btn" onclick="toggleService(event, 'bazarr')">
                <img src="/img/play.webp" alt="Start Bazarr">
            </button>
            <img src="/img/bazarr.webp" alt="Bazarr">
            <div class="tile-name">Bazarr</div>
            <div class="tile-desc" data-desc-de="Untertitel" data-desc-en="Subtitles"></div>
        </a>

        <a class="tile" id="tile-tdarr" href="/tdarr">
            <button class="control-btn" onclick="toggleService(event, 'tdarr')">
                <img src="/img/play.webp" alt="Start Tdarr">
            </button>
            <img src="/img/tdarr.webp" alt="Tdarr">
            <div class="tile-name">Tdarr</div>
            <div class="tile-desc" data-desc-de="Transkodieren" data-desc-en="Re-encode"></div>
        </a>

        <a class="tile" id="tile-sabnzbd" href="/sabnzbd">
            <button class="control-btn" onclick="toggleService(event, 'sabnzbd')">
                <img src="/img/play.webp" alt="Start SABnzbd">
            </button>
            <img src="/img/sabnzbd.webp" alt="SABnzbd">
            <div class="tile-name">SABnzbd</div>
            <div class="tile-desc" data-desc-de="Downloads" data-desc-en="Downloads"></div>
        </a>

        <a class="tile" id="tile-jellyfin" href="/jellyfin">
            <button class="control-btn" onclick="toggleService(event, 'jellyfin')">
                <img src="/img/play.webp" alt="Start Jellyfin">
            </button>
            <img src="/img/jellyfin.webp" alt="Jellyfin">
            <div class="tile-name">Jellyfin</div>
            <div class="tile-desc" data-desc-de="Streamen" data-desc-en="Streaming"></div>
        </a>

        <a class="tile" id="tile-plex" href="/plex">
            <button class="control-btn" onclick="toggleService(event, 'plex')">
                <img src="/img/play.webp" alt="Start Plex">
            </button>
            <img src="/img/plex.webp" alt="Plex">
            <div class="tile-name">Plex</div>
            <div class="tile-desc" data-desc-de="Streamen" data-desc-en="Streaming"></div>
        </a>

        <a class="tile" id="tile-jellyseerr" href="/jellyseerr">
            <button class="control-btn" onclick="toggleService(event, 'jellyseerr')">
                <img src="/img/play.webp" alt="Start Jellyseerr">
            </button>
            <img src="/img/jellyseerr.webp" alt="Jellyseerr">
            <div class="tile-name">Jellyseerr</div>
            <div class="tile-desc" data-desc-de="Suchen" data-desc-en="Discover"></div>
        </a>
        <!-- ===== Shutdown Button (Red) ===== -->
        <a class="tile" style="background-color: #e43e4f;" href="javascript:void(0);" onclick="shutdown()">
            <img src="/img/shutdown.webp" alt="Shutdown">
            <div class="tile-name">Shutdown</div>
            <div class="tile-desc"></div>
        </a>

        
    </div>
    
    <script>
        /* ========================================= */
        /* ========= J A V A   S C R I P T ========= */
        /* ========================================= */
/* ========================================= */

        let noobMode = false;
        let lang = "de";
        let adminPassword = null;

        const toggleSwitch = document.getElementById("toggleSwitch");   
        const langToggle = document.getElementById("langToggle");       
        const adminToggle = document.getElementById("adminToggle");     
        const tiles = document.querySelectorAll(".tile");
        const actionText = document.getElementById("action-status");


        // ===== Noob/Pro toggle =====
        toggleSwitch.addEventListener("click", () => {
            noobMode = !noobMode;
            toggleSwitch.classList.toggle("on", !noobMode);
            updateTileDescriptions();
        });


        // ===== Language toggle =====
        langToggle.addEventListener("click", () => {
            lang = (lang === "de") ? "en" : "de";
            langToggle.classList.toggle("on", lang === "en");
            updateTileDescriptions();
        });


        // ===== Website Load =====
        window.addEventListener("DOMContentLoaded", async () => {
            await loadWebsiteAdminTry();
            toggleSwitch.classList.toggle("on", !noobMode);
            langToggle.classList.toggle("on", lang === "en");
            adminToggle.classList.toggle("on", !!adminPassword);
            updateTileDescriptions();
        });


        // ===== Tile Descriptions =====
        function updateTileDescriptions() {
            tiles.forEach(tile => {
                const descDiv = tile.querySelector(".tile-desc");
                if (!descDiv) return;

                if (noobMode) {
                    descDiv.textContent = (lang === "en") ? descDiv.dataset.descEn : descDiv.dataset.descDe;
                    descDiv.classList.add("visible");
                } else {
                    descDiv.classList.remove("visible");
                }
            });
        }


        // ===== Admin toggle =====
        adminToggle.addEventListener("click", async () => {
            if (!adminPassword) {
                const pw = prompt("Enter password to unlock Admin actions:");
                if (!pw) return;

                try {
                    const res = await fetch('/verify-password', {
                        method: 'POST',
                        headers: {'Content-Type':'application/json'},
                        body: JSON.stringify({password: pw})
                    });
                    const text = await res.text();
                    if (text === "OK") {
                        adminPassword = pw;
                        adminToggle.classList.add("on");
                    } else {
                        actionText.textContent = "Incorrect password!";
                    }
                } catch (e) {
                    alert("Error: " + e);
                }
            } else {
                adminPassword = null;
                adminToggle.classList.remove("on");
            }
        });


        // ===== See if admin on LoadWebsite =====
        async function loadWebsiteAdminTry()  {
            if (!adminPassword) {
                const pw = "Test";
                try {
                    const res = await fetch('/verify-password', {
                        method: 'POST',
                        headers: {'Content-Type':'application/json'},
                        body: JSON.stringify({password: pw})
                    });
                    const text = await res.text();
                    if (text === "OK") {
                        adminPassword = pw;
                        adminToggle.classList.add("on");
                        return;
                    }
                } catch (e) {
                    alert("Error: " + e);
                }
            }
            adminPassword = null;
            adminToggle.classList.remove("on");
        }


        // ===== Fetch Service Status & Update Tiles =====
        function updateServiceStatus() {
            fetch('/service-status')
                .then(response => response.json())
                .then(data => {
                    for (const [service, running] of Object.entries(data)) {
                        const tile = document.getElementById(`tile-${service}`);
                        if (!tile) continue;

                        tile.style.backgroundColor = running ? '#28a745' : '#dc3545';

                        const btnImg = tile.querySelector(".control-btn img");
                        if (btnImg) {
                            btnImg.src = running ? "/img/pause.webp" : "/img/play.webp";
                        }
                    }
                });
        }
        // Run immediately, then every 1000ms
        updateServiceStatus();
        setInterval(updateServiceStatus, 1000);


        // ===== Service buttons Start / Stop =====
        function toggleService(event, service) {
            event.stopPropagation();
            event.preventDefault();

            if (!adminPassword) {
                alert("Switch to Admin and enter password first!");
                return;
            }

            fetch('/service-status')
                .then(r => r.json())
                .then(status => {
                    const running = status[service];
                    const url = running ? `/stop/${service}` : `/start/${service}`;
                    
                    fetch(url, {
                        method: 'POST',
                        headers: {'Content-Type':'application/json'},
                        body: JSON.stringify({password: adminPassword})
                    })
                    .then(r => r.text())
                    .then(d => actionText.textContent = d)
                    .catch(e => actionText.textContent = "Error: " + e);
                });
        }


        // ===== Shutdown =====
        function shutdown() {
            if (!adminPassword) {
                alert("Switch to Admin and enter password first!");
                return;
            }

            if (!confirm("Are you sure you want to shutdown?")) return;

            actionText.textContent = "Processing shutdown...";
            fetch('/shutdown', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({password: adminPassword})
            })
            .then(r => r.text())
            .then(d => { actionText.textContent = d; })
            .catch(e => { actionText.textContent = 'Error: ' + e; });
        }

           
    </script>
</body>
</html>
